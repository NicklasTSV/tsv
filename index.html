
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mannschaftsapp – Strafenkasse</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#c42805" />

  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      margin: 0;
    }
    header {
      background: #000000;
      color: white;
      padding: 15px;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: center;
      background: #c42805;
      flex-wrap: wrap;
    }
    nav button {
      background: none;
      border: none;
      color: white;
      padding: 15px;
      cursor: pointer;
      font-size: 16px;
    }
    nav button:hover {
      background: #a30000;
    }
    section {
      max-width: 800px;
      margin: auto;
      padding: 20px;
      display: none;
    }
    input, select, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .clickable {
      cursor: pointer;
      color: blue;
      text-decoration: underline;
    }
  </style>
 
  
</head>
<body>
<header>
  <h1>⚽ Mannschafts-App <br> TSV Dramfeld</h1>
</header>

<nav>
  <button onclick="switchPage('home')">Strafen</button>
  <button onclick="switchPage('catalog')">Strafenkatalog</button>
  <button onclick="switchPage('schedule')">Termine</button>
  <button onclick="switchPage('docs')">Dokumente</button>
  <button id="navTraining" onclick="switchPage('trainingSection')" style="display: none;">📅 Training</button>
  <button id="navFund" onclick="switchPage('fundSection')" style="display:none">💰 Mannschaftskasse</button>
</nav>

<section id="login">
  <h2>🔐 Zugang</h2>
  <input type="password" id="pinInput" placeholder="PIN eingeben" />
  <button onclick="checkPIN()">Weiter</button>
</section>

<section id="home">
  <h2>Strafenübersicht</h2>
  <div id="penaltyEntry">
    <select id="playerSelect"></select>
    <select id="penaltySelect"></select>
    <button onclick="addPenalty()">Strafe eintragen</button>
  </div>
  <!-- Freitext-Strafe: zunächst versteckt -->
<div id="customPenaltyFields" style="display:none; margin-top:8px;">
  <input id="customPenaltyName" placeholder="Beschreibung (z. B. „Kasse vergessen“)" />
  <input id="customPenaltyAmount" type="number" step="0.01" min="0" placeholder="Betrag in €" />
</div>
<table>
  <thead>
    <tr>
      <th>Spieler</th>
      <th>Summe (€)</th>
      <th>Zu bezahlen (€)</th> <!-- neu -->
    </tr>
  </thead>
  <tbody id="summaryTable"></tbody>
</table>
</section>

<section id="catalog">
  <h2>Strafenkatalog</h2>

  <p>
    📄 <a href="https://nicklastsv.github.io/tsv/Strafen TSV.pdf" target="_blank">
      Strafenkatalog TSV (PDF)
    </a>
  </p>

  <ul id="penaltyList"></ul>
</section>

<section id="schedule">
  <h2>Termine</h2>
  <ul id="eventList"></ul>
</section>

<section id="docs">
  <h2>Dokumente</h2>
  <ul id="docList"></ul>
</section>

<section id="adminPanel">
  <h2>🔧 Admin Panel</h2>
  <div>
    <h3>Strafen</h3>
    <input id="newPenaltyName" placeholder="Strafe" />
    <input id="newPenaltyAmount" type="number" placeholder="Betrag" />
    <button onclick="addNewPenalty()">Hinzufügen</button>
    <ul id="adminPenaltyList"></ul>

    <h3>Spieler</h3>
    <input id="newPlayer" placeholder="Spielername" />
    <button onclick="addNewPlayer()">Hinzufügen</button>
    <ul id="adminPlayerList"></ul>

    <h3>Dokumente</h3>
    <input id="newDocName" placeholder="Name" />
    <input id="newDocURL" placeholder="https://..." />
    <button onclick="addNewDoc()">Hinzufügen</button>
    <ul id="adminDocList"></ul>

    <h3>Termine</h3>
    <input id="newEventText" placeholder="Terminbeschreibung" />
    <input id="newEventDate" type="date" />
    <button onclick="addNewEvent()">Hinzufügen</button>
    <ul id="adminEventList"></ul>
  </div>
</section>
  
</section>

<!-- 🔒 Nur für Admin sichtbar -->
<section id="trainingSection" style="display:none">
  <h2>📅 Trainingsverwaltung</h2>

  <h3>Trainingstage</h3>
  <input id="trainingDate" type="date" />
  <button onclick="addTrainingDate()">Trainingstag hinzufügen</button>
  <div id="trainingList"></div>

  <h3>📋 Anwesenheitsübersicht</h3>
  <div id="trainingStats"></div>

  <button onclick="switchPage('home')">🔙 Zurück</button>
</section>

<!-- 🆕 Mannschaftskasse (nur Admin) -->
<section id="fundSection" style="display:none; max-width:800px; margin:auto; padding:20px;">
  <h2>💼 Mannschaftskasse</h2>

<!-- 🧭 Perioden-Manager (nur Admin) -->
<div id="fundPeriodManager" style="margin:12px 0; padding:10px; border:1px solid #ddd; border-radius:8px;">
  <h3 style="margin:0 0 8px 0;">Perioden verwalten</h3>

  <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    <input id="newFundPeriod" placeholder="z. B. 2025-H1 oder 2025-Q1" />
    <button id="addFundPeriodBtn">➕ Periode hinzufügen</button>
  </div>

  <ul id="fundPeriodsList" style="margin:10px 0 0 0; padding-left:18px;"></ul>
</div>

  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:12px 0;">
    <label>Periode:
      <select id="fundPeriod"></select>
    </label>
    <label>Betrag pro Spieler:
      <input id="fundAmount" type="number" step="0.01" min="0" style="width:120px" />
    </label>
    <button id="fundSaveAmountBtn">Betrag speichern</button>
  </div>

  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr>
        <th style="text-align:left; padding:8px;">Spieler</th>
        <th style="text-align:center; padding:8px;">Bezahlt?</th>
        <th style="text-align:left; padding:8px;">Bezahlt am</th>
      </tr>
    </thead>
    <tbody id="fundTableBody"></tbody>
  </table>

  <div style="margin-top:12px;">
    <button onclick="switchPage('home')">🔙 Zurück</button>
  </div>
</section>

<script>

  // Session-Login-Zustände
  const ROLE_VIEWER = "viewer";
  const ROLE_EDITOR = "editor";
  const ROLE_COACH = "coach";
  const ROLE_ADMIN = "admin";

  let sessionRole = sessionStorage.getItem("role");

  function isLoggedIn() {
    return sessionRole !== null;
  }

  function loginWithPIN(pin) {
    if (pin === BASIC_PIN) {
      sessionStorage.setItem("role", ROLE_VIEWER);
      userRole = ROLE_VIEWER;
      switchPage("home");
    } else if (pin === POWER_PIN) {
      sessionStorage.setItem("role", ROLE_EDITOR);
      userRole = ROLE_EDITOR;
      switchPage("home");
    } else if (pin === ADMIN_PIN) {
      sessionStorage.setItem("role", ROLE_ADMIN);
      userRole = ROLE_ADMIN;
      switchPage("adminPanel");
    } else if (pin === COACH_PIN) {
    sessionStorage.setItem("role", "ROLE_COACH");
    userRole = "ROLE_COACH";
    switchPage("home");
    } else {
      alert("Falsche PIN!");
      return;
    }
    setupApp();
  }

  function requireLogin(page) {
    if (!isLoggedIn()) {
      alert("Bitte zuerst PIN eingeben.");
      switchPage("login");
      return false;
    }
    return true;
  }

  window.onload = () => {
    const savedRole = sessionStorage.getItem("role");
      if (savedRole) {
      userRole = savedRole;
        if (userRole === ROLE_ADMIN) {
        switchPage("adminPanel");
        } else {
        switchPage("home");
        }
      setupApp();
    } else {
      switchPage("login");
    }
  };

  const BASIC_PIN = "TSV_1919";
  const POWER_PIN = "Strafe!1919";
  const COACH_PIN = "anwesenheit!1919";
  const ADMIN_PIN = "1919!Strafen2025";
  let userRole = null;

let penalties = []; // z. B. [{id: "...", name: "...", amount: 5}]

let playerPenalties = {};

function loadPenaltyCatalog() {
  const refCatalog = ref(db, "penalties"); // Korrigierter Pfad!

  onValue(refCatalog, (snapshot) => {
    const data = snapshot.val();
    penalties = data
      ? Object.entries(data).map(([id, p]) => ({
          id,
          name: p.name,
          amount: p.amount
        }))
      : [];

    updateSelects();
    updatePenaltyList();
    updateAdminPanel();
  });
}

function loadPlayerPenalties() {
  const refPenalties = ref(db, "playerPenalties");
  get(refPenalties).then((snapshot) => {
    playerPenalties = snapshot.val() || {};
    
  }).catch((error) => {
    console.error("Fehler beim Laden der Strafen:", error);
  });
}

let players = []; // z. B. [{id: "...", name: "Max"}, ...]

function loadPlayersFromFirebase() {
  const playersRef = ref(db, "players");
  return get(playersRef).then((snapshot) => {
    const data = snapshot.val();
    players = [];

    if (data) {
      // Wenn deine Struktur so ist: { id123: "Spielername" }
      Object.entries(data).forEach(([id, name]) => {
        players.push({ id, name });
      });
    } else {
      console.warn("⚠️ Keine Spielerdaten gefunden.");
    }
  }).catch((error) => {
    console.error("❌ Fehler beim Laden der Spieler:", error);
  });
}

function loadDocsFromFirebase() {
  const ul = document.getElementById("docList");
  const adminUl = document.getElementById("adminDocList");

  onValue(ref(db, "documents"), (snapshot) => {
    const data = snapshot.val() || {};
    ul.innerHTML = "";
    adminUl.innerHTML = "";

    Object.entries(data).forEach(([key, doc]) => {
      const item = `<a href="${doc.url}" target="_blank">${doc.name}</a>`;
      const deleteBtn = (userRole === "admin")
        ? ` <button onclick="deleteDoc('${key}')">🗑️</button>`
        : "";

      ul.innerHTML += `<li>${item}${deleteBtn}</li>`;
      adminUl.innerHTML += `<li>${item}${deleteBtn}</li>`;
    });
  });
}

function loadEventsFromFirebase() {
  const ul = document.getElementById("eventList");
  const adminUl = document.getElementById("adminEventList");

  onValue(ref(db, "events"), (snapshot) => {
    const data = snapshot.val() || {};
    ul.innerHTML = "";
    adminUl.innerHTML = "";

    Object.entries(data).forEach(([key, e]) => {
      const item = `📅 ${e.date} – ${e.text}`;
      const deleteBtn = (userRole === "admin")
        ? ` <button onclick="deleteEvent('${key}')">🗑️</button>`
        : "";

      ul.innerHTML += `<li>${item}${deleteBtn}</li>`;
      adminUl.innerHTML += `<li>${item}${deleteBtn}</li>`;
    });
  });
}

  let summary = JSON.parse(localStorage.getItem("summary")) || {};
  
  // nicht mehr benötigt: let docs = JSON.parse(localStorage.getItem("docs")) || [];
  // nicht mehr benötigt: let events = JSON.parse(localStorage.getItem("events")) || [];

function switchPage(id) {
  const role = sessionStorage.getItem("role");

  // Zugriffsschutz: Nur zur Login-Seite, wenn nicht eingeloggt
  if (!role && id !== "login") {
    alert("Bitte zuerst PIN eingeben.");
    return switchPage("login");
  }

  // Alle Seiten ausblenden
  document.querySelectorAll("section").forEach(s => s.style.display = "none");

  // Gewünschte Seite anzeigen
  const target = document.getElementById(id);
  if (target) {
    target.style.display = "block";

    // 🔹 Spezielle Seiten-Initialisierungen
    if (id === "fundSection") {
      if (userRole !== "admin") {
        alert("Keine Berechtigung.");
        return switchPage("home");
      }
      refreshFundPeriodsUI(); // neue Funktion lädt Dropdown, Tabelle & Betrag
    }

    if (id === "training") {
      loadTrainings();
      calculateAttendanceStats();
    }

  } else {
    console.warn("❌ Seite nicht gefunden:", id);
  }
}
  
function checkPIN() {
  const pin = document.getElementById("pinInput").value;

  if (pin === BASIC_PIN) {
    sessionStorage.setItem("role", "viewer");
    userRole = "viewer";
    switchPage("home");
  } else if (pin === POWER_PIN) {
    sessionStorage.setItem("role", "editor");
    userRole = "editor";
    switchPage("home");
  } else if (pin === COACH_PIN) {
    sessionStorage.setItem("role", "coach");
    userRole = "coach";
  } else if (pin === ADMIN_PIN) {
    sessionStorage.setItem("role", "admin");
    userRole = "admin";

    // ✅ Nur Admin sieht den Trainings-Link
    document.getElementById("navTraining").style.display = "inline-block";

    switchPage("adminPanel");
  } else {
    alert("Falsche PIN!");
    return;
  }

  setupApp(); // App-Daten laden, Rollen-Funktionen aktivieren
}

function logout() {
  sessionStorage.clear(); // Login-Status löschen
  switchPage("login");    // zurück zur Login-Seite
}

function setupApp() {
  loadPlayersFromFirebase();
  updateSelects();
  updateSummary();
  updatePlayerSelect();       // neu
  updatePenaltySelect();      // neu
  registerCustomPenaltyToggle();
  loadPenaltyCatalog();
  loadPlayerPenalties();
  loadEventsFromFirebase();
  loadDocsFromFirebase();

  updateAdminPanel();

  // Rollenbasierte Anzeige
  document.getElementById("penaltyEntry").style.display =
    (userRole === "editor" || userRole === "admin") ? "block" : "none";

  // Admin-Panel nur für Admins sichtbar machen
  document.getElementById("adminPanel").style.display = (userRole === "admin") ? "block" : "none";

  // Nur Admin und coach darf Training sehen und vorbereiten
  if (userRole === "admin" || userRole === "coach") {
    document.getElementById("navTraining").style.display = "inline-block";
    loadTrainings();
    calculateAttendanceStats();
  }
  // 🆕 Mannschaftskasse vorbereiten (nur Admin sieht den Menüpunkt)
const navFund = document.getElementById("navFund");
if (navFund) {
  navFund.style.display = (userRole === "admin") ? "inline-block" : "none";
}

// Events für Periode/Betrag nur einmal hängen
const fundPeriodEl = document.getElementById("fundPeriod");
const fundSaveBtn  = document.getElementById("fundSaveAmountBtn");

if (fundPeriodEl && !fundPeriodEl._bound) {
  fundPeriodEl.addEventListener("change", loadTeamFund);
  fundPeriodEl._bound = true;
}
if (fundSaveBtn && !fundSaveBtn._bound) {
  fundSaveBtn.addEventListener("click", saveFundAmount);
  fundSaveBtn._bound = true;
}

// Periode-Dropdown einmalig füllen
buildFundPeriodOptions();

document.getElementById("addFundPeriodBtn")?.addEventListener("click", addFundPeriod);
document.getElementById("fundPeriod")?.addEventListener("change", loadTeamFund);
document.getElementById("saveFundAmountBtn")?.addEventListener("click", saveFundAmount);
}
  
function calculateAttendanceStats() {
  const trainingRef = ref(db, "trainings");

  get(trainingRef).then((snapshot) => {
    const data = snapshot.val() || {};
    const stats = {};

    Object.values(data).forEach(training => {
      Object.entries(training.players || {}).forEach(([playerId, status]) => {
        if (!stats[playerId]) {
          stats[playerId] = { total: 0, present: 0 };
        }
        stats[playerId].total++;
        if (status === "anwesend") {
          stats[playerId].present++;
        }
      });
    });

    const playerStats = players.map(p => {
      const s = stats[p.id] || { total: 0, present: 0 };
      const percent = s.total > 0 ? ((s.present / s.total) * 100).toFixed(1) : null;
      return {
        id: p.id,
        name: p.name,
        percent: percent !== null ? parseFloat(percent) : null
      };
    });

    const validStats = playerStats.filter(p => p.percent !== null);
    const sorted = [...validStats].sort((a, b) => b.percent - a.percent);
    const top3 = sorted.slice(0, 3).map(p => p.id);
    const bottom3 = sorted.slice(-3).map(p => p.id);

    // 👉 HTML komplett vorbereiten
    let html = `
      <h3>📊 Anwesenheitsstatistik</h3>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 8px;">Spieler</th>
              <th style="text-align: left; padding: 8px;">Anwesenheit</th>
            </tr>
          </thead>
          <tbody>
    `;

    playerStats.forEach(p => {
      let colorStyle = "";
      if (top3.includes(p.id)) {
        colorStyle = 'color: green; font-weight: bold;';
      } else if (bottom3.includes(p.id)) {
        colorStyle = 'color: red; font-weight: bold;';
      }

      const percentText = p.percent !== null ? `${p.percent} %` : "–";

      html += `
        <tr>
          <td style="padding: 6px;">${p.name}</td>
          <td style="padding: 6px; ${colorStyle}">${percentText}</td>
        </tr>
      `;
    });

    html += `
          </tbody>
        </table>
      </div>
    `;

    // 🟢 Jetzt einmalig setzen
    const container = document.getElementById("trainingStats");
    container.innerHTML = html;
  }).catch((error) => {
    console.error("Fehler bei Anwesenheitsstatistik:", error);
  });
}

function updateSelects() {
  const ps = document.getElementById("playerSelect");
  const pe = document.getElementById("penaltySelect");

  if (!ps || !pe || !players || !penalties) return;

  // Spielerliste aufbauen
  ps.innerHTML = "";
  players.forEach(player => {
    ps.innerHTML += `<option value="${player.id}">${player.name}</option>`;
  });

  // Strafenliste aufbauen
  pe.innerHTML = "";

  // 🆕 Freitext-Strafe Option zuerst
  pe.innerHTML += `<option value="">– Strafe wählen –</option>`;
  pe.innerHTML += `<option value="custom">📝 Freitext-Strafe …</option>`;

  // Danach alle bestehenden Strafen
  penalties.forEach((penalty, i) => {
    pe.innerHTML += `<option value="${i}">${penalty.name} (${penalty.amount} €)</option>`;
  });
}

function addPenalty() {
  // Rollen-Check
  if (userRole !== "editor" && userRole !== "admin") {
    alert("Du hast keine Berechtigung, Strafen hinzuzufügen.");
    return;
  }

  const playerId = document.getElementById("playerSelect").value;
  const selected = document.getElementById("penaltySelect").value;
  if (!playerId || !selected) return;

  let penaltyName, amount;
  let entryMeta; // 🔸 optional: Zusatzinfos für Historie

  if (selected === "custom") {
    // ⚠️ Freitext aus Formfeldern lesen (statt prompt)
    const nameEl = document.getElementById("customPenaltyName");
    const amtEl  = document.getElementById("customPenaltyAmount");

    const name = (nameEl?.value || "").trim();
    const amtStr = String(amtEl?.value || "").replace(",", ".");
    const parsed = parseFloat(amtStr);

    if (!name || isNaN(parsed) || parsed <= 0) {
      alert("Bitte Freitext und einen gültigen Betrag eingeben.");
      return;
    }

    penaltyName = name;
    amount = Math.round(parsed * 100) / 100; // 2 Nachkommastellen
  } else {
    // Katalog-Strafe
    const idx = parseInt(selected, 10);
    const p = penalties[idx];
    if (!p) return;

    // Standard: fixer Betrag
    penaltyName = p.name;
    amount = Number(p.amount) || 0;

    // 🔸 Minimal‑Patch: Erkenne „pro 5 Min“/„je 5 Min“ usw. und berechne dynamisch
    const nameLower = String(p.name).toLowerCase();
    const isPer5Min = /(pro|je)\s*5\s*min/.test(nameLower);
    if (isPer5Min) {
      const minutesInput = prompt("Wie viele Minuten zu spät?");
      if (minutesInput === null) return; // abgebrochen

      const minutes = parseInt(String(minutesInput).replace(",", "."), 10);
      if (isNaN(minutes) || minutes < 0) {
        alert("Ungültige Minutenangabe.");
        return;
      }

      const step = 5;                      // 5‑Minuten‑Schritte
      const units = Math.ceil(minutes / step);
      const rate = Number(p.amount) || 0;  // Betrag pro 5 Minuten (aus Katalog)
      amount = units * rate;

      // Namen kenntlich machen + optionale Metadaten
      penaltyName = `${p.name} (${minutes} Min)`;
      entryMeta = { minutes, step, units, rate, calc: "ceil(minutes/step)*rate" };
    }
  }

  const entry = {
    name: penaltyName,
    amount: amount,
    timestamp: new Date().toISOString(),
    ...(entryMeta ? { meta: entryMeta } : {}) // 🔸 nur wenn gesetzt
  };

  const penaltyRef = push(ref(db, `playerPenalties/${playerId}`));
  set(penaltyRef, entry)
    .then(() => {
      // UI zurücksetzen
      const pe = document.getElementById("penaltySelect");
      pe.value = ""; // Auswahl leeren

      // Freitext-Felder leeren & ausblenden
      const nameEl = document.getElementById("customPenaltyName");
      const amtEl  = document.getElementById("customPenaltyAmount");
      if (nameEl) nameEl.value = "";
      if (amtEl)  amtEl.value  = "";
      const box = document.getElementById("customPenaltyFields");
      if (box) box.style.display = "none";

      updateSummary();
    })
    .catch((err) => {
      console.error("Fehler beim Hinzufügen der Strafe:", err);
      alert("Fehler beim Hinzufügen der Strafe.");
    });
}

function updatePlayerSelect() {
  const ps = document.getElementById("playerSelect");
  if (!ps || !players) return;

  ps.innerHTML = "";
  players.forEach(p => {
    ps.innerHTML += `<option value="${p.id}">${p.name}</option>`;
  });
}

function updatePenaltySelect() {
  const pe = document.getElementById("penaltySelect");
  if (!pe || !penalties) return;

  pe.innerHTML = "";
  Object.entries(penalties).forEach(([key, pen]) => {
    pe.innerHTML += `<option value="${key}">${pen.name} (${pen.amount} €)</option>`;
  });
}

// Erzeugt eine "fixierte" Zahlungsanfrage aus den aktuell offenen Strafen
function createPaymentRequest(playerId) {
  const listRef = ref(db, `playerPenalties/${playerId}`);
  get(listRef).then(snap => {
    const all = snap.val() || {};
    const entries = Object.entries(all);
    if (entries.length === 0) {
      alert("Keine offenen Strafen zum Fixieren.");
      return;
    }

    const keys = entries.map(([k]) => k);
    const total = entries.reduce((sum, [,p]) => sum + (Number(p.amount)||0), 0);
    const reqId = Date.now();

    const reqRef = ref(db, `paymentRequests/${playerId}/${reqId}`);
    return set(reqRef, {
      createdAt: new Date(reqId).toISOString(),
      keys,
      total: Math.round(total*100)/100,
      status: "pending"
    });
  }).then(() => {
    alert("Zahlungsstand fixiert.");
    showPlayerDetails(playerId);
  }).catch(err => {
    console.error("PaymentRequest Fehler:", err);
    alert("Fehler beim Fixieren.");
  });
}

function markPaymentRequestAsPaid(playerId, requestId) {
  const reqRef = ref(db, `paymentRequests/${playerId}/${requestId}`);
  get(reqRef).then(snap => {
    const req = snap.val();
    if (!req || !Array.isArray(req.keys) || req.keys.length === 0) {
      alert("Anfrage nicht gefunden oder leer.");
      return;
    }

    // Aktuelle Strafdaten holen, um die Objekte zu archivieren
    const listRef = ref(db, `playerPenalties/${playerId}`);
    return get(listRef).then(listSnap => {
      const all = listSnap.val() || {};
      const items = req.keys.map(k => all[k]).filter(Boolean);

      const archiveRef = ref(db, `paidPenalties/${playerId}/${Date.now()}`);
      return set(archiveRef, {
        paidAt: new Date().toISOString(),
        items
      }).then(() => {
        // Nur die in der Anfrage enthaltenen Keys löschen
        const updates = {};
        req.keys.forEach(k => updates[k] = null);
        return update(listRef, updates);
      }).then(() => {
        // Anfrage auf "paid" setzen
        return update(reqRef, { status: "paid" });
      });
    });
  }).then(() => {
    alert("Fixierter Betrag bezahlt & archiviert.");
    updateSummary();
    showPlayerDetails(playerId);
  }).catch(err => {
    console.error("markPaymentRequestAsPaid Fehler:", err);
    alert("Fehler beim Bezahlen.");
  });
}

function registerCustomPenaltyToggle() {
  const pe = document.getElementById("penaltySelect");
  const box = document.getElementById("customPenaltyFields");
  if (!pe || !box) return;

  const toggle = () => {
    box.style.display = (pe.value === "custom") ? "block" : "none";
  };

  // Handler setzen (überschreibt ggf. einen alten, verhindert doppelte Listener)
  pe.onchange = toggle;

  // Beim ersten Laden gleich korrekt setzen
  toggle();
}

function updateSummary() {
  const tb = document.getElementById("summaryTable");
  if (!tb) return;
  tb.innerHTML = "";

  Promise.all([
    get(ref(db, "playerPenalties")),
    get(ref(db, "fixedPenalties"))
  ]).then(([penSnap, fixedSnap]) => {
    const penData   = penSnap.val()   || {};
    const fixedData = fixedSnap.val() || {};

    players.forEach(player => {
      // offene Strafen live summieren
      const playerPen = penData[player.id] || {};
      let openSum = 0;
      Object.values(playerPen).forEach(p => {
        if (p && typeof p.amount === "number") openSum += p.amount;
      });

      // fixierter Betrag (zu bezahlen)
      let toPay = 0;
      const fixed = fixedData[player.id];
      if (fixed) {
        if (typeof fixed.amount === "number") {
          toPay = fixed.amount;
        } else if (Array.isArray(fixed.items)) {
          toPay = fixed.items.reduce((s, it) => s + (Number(it.amount) || 0), 0);
        }
      }

      tb.innerHTML += `
        <tr>
          <td class="clickable" onclick="showPlayerDetails('${player.id}')">${player.name}</td>
          <td>${openSum.toFixed(2)} €</td>
          <td>${toPay.toFixed(2)} €</td>
        </tr>`;
    });
  }).catch(err => {
    console.error("updateSummary() Fehler:", err);
  });
}

function updatePenaltyList() {
  const ul = document.getElementById("penaltyList");
  ul.innerHTML = "";
  penalties.forEach(p => {
    ul.innerHTML += `<li>${p.name} – ${p.amount.toFixed(2)} €</li>`;
  });
}

function updateAdminPanel() {
  const adminPlayerList = document.getElementById("adminPlayerList");
  const adminPenaltyList = document.getElementById("adminPenaltyList");

  // 🟩 Spieler aktualisieren
  adminPlayerList.innerHTML = "";
  players.forEach(player => {
    adminPlayerList.innerHTML += `
      <li>
        ${player.name}
        <button onclick="deletePlayer('${player.id}')">🗑️</button>
      </li>`;
  });

  // 🟩 Strafen aktualisieren
  adminPenaltyList.innerHTML = penalties.map((p) =>
    `<li>${p.name} – ${p.amount.toFixed(2)} € <button onclick="deletePenalty('${p.id}')">🗑️</button></li>`
  ).join("");

  // ❌ Dokumente und Events werden NICHT mehr hier aufgebaut!
  // Stattdessen erfolgt ihre Darstellung durch loadDocsFromFirebase() & loadEventsFromFirebase()
}

function addNewPenalty() {
  const name = document.getElementById("newPenaltyName").value;
  const amount = parseFloat(document.getElementById("newPenaltyAmount").value);
  if (!name || isNaN(amount)) return;

  const newRef = push(ref(db, "penalties"));
  set(newRef, { name, amount })
    .then(() => {
      document.getElementById("newPenaltyName").value = "";
      document.getElementById("newPenaltyAmount").value = "";
    })
    .catch((error) => {
      console.error("Fehler beim Speichern der Strafe:", error);
    });
}
function deletePenalty(id) {
  const penRef = ref(db, "penalties/" + id);
  remove(penRef).catch((error) => {
    console.error("Fehler beim Löschen:", error);
  });
}

function addNewPlayer() {
  const name = document.getElementById("newPlayer").value;
  if (!name) return;

  const playerRef = push(ref(db, "players"));  // Neue ID in "players/"
  set(playerRef, name).then(() => {
    document.getElementById("newPlayer").value = "";
    alert("Spieler hinzugefügt!");
  }).catch((error) => {
    console.error("Fehler beim Hinzufügen des Spielers:", error);
  });
}

function deletePlayer(id) {
  const playerRef = ref(db, "players/" + id);
  remove(playerRef).then(() => {
    alert("Spieler gelöscht!");
  }).catch((error) => {
    console.error("Fehler beim Löschen des Spielers:", error);
  });
}

// 📄 Dokument hinzufügen
function addNewDoc() {
  const name = document.getElementById("newDocName").value;
  const url = document.getElementById("newDocURL").value;
  if (!name || !url) return;

  const newRef = push(ref(db, "documents"));
  set(newRef, {
    name,
    url,
    timestamp: Date.now()
  }).then(() => {
    document.getElementById("newDocName").value = "";
    document.getElementById("newDocURL").value = "";
    loadDocsFromFirebase(); // ✅ Liste aktualisieren
  }).catch((error) => {
    console.error("Fehler beim Speichern des Dokuments:", error);
  });
}

// 📄 Dokument löschen
function deleteDoc(key) {
  remove(ref(db, `documents/${key}`))
    .then(() => loadDocsFromFirebase())
    .catch((error) => {
      console.error("Fehler beim Löschen des Dokuments:", error);
    });
}

// 📅 Termin hinzufügen
function addNewEvent() {
  const text = document.getElementById("newEventText").value;
  const date = document.getElementById("newEventDate").value;
  if (!text || !date) return;

  const newRef = push(ref(db, "events"));
  set(newRef, {
    text,
    date,
    timestamp: Date.now()
  }).then(() => {
    document.getElementById("newEventText").value = "";
    document.getElementById("newEventDate").value = "";
    loadEventsFromFirebase(); // ✅ Liste aktualisieren
  }).catch((error) => {
    console.error("Fehler beim Hinzufügen des Termins:", error);
  });
}

// 📅 Termin löschen
function deleteEvent(key) {
  remove(ref(db, `events/${key}`))
    .then(() => loadEventsFromFirebase())
    .catch((error) => {
      console.error("Fehler beim Löschen des Termins:", error);
    });
}

function addTrainingDate() {
  const date = document.getElementById("trainingDate").value;
  if (!date) return;

  const trainingRef = ref(db, `trainings/${date}`);

  const initialPlayers = {};
  players.forEach(p => {
    initialPlayers[p.id] = "absent";
  });

  const initialData = {
    players: initialPlayers
  };

  set(trainingRef, initialData)
    .then(() => {
      alert("Trainingstermin angelegt.");
      document.getElementById("trainingDate").value = "";
      loadTrainings();
    })
    .catch((err) => {
      console.error("Fehler beim Anlegen des Trainings:", err);
    });
}

function loadTrainings() {
  const container = document.getElementById("trainingList");
  if (!container) return;

  const trainingsRef = ref(db, "trainings");
  onValue(trainingsRef, (snapshot) => {
    const data = snapshot.val();
    container.innerHTML = "";

    if (!data) {
      container.innerHTML = "<p>Keine Trainingsdaten vorhanden.</p>";
      return;
    }

    Object.entries(data).forEach(([date, training]) => {
      const playersData = training.players || {}; // ✅ korrekt auf trainings/<datum>/players zugreifen

      let html = `<h4>${date} <button onclick="deleteTraining('${date}')">🗑️</button></h4>`;
      html += `<table><tr><th>Spieler</th><th>Status</th></tr>`;

      players.forEach(player => {
        const status = playersData[player.id] || "";

        html += `
          <tr>
            <td>${player.name}</td>
            <td>
              <select onchange="updatePlayerTrainingStatus('${date}', '${player.id}', this.value)">
                <option value="" ${status === "" ? "selected" : ""}>–</option>
                <option value="anwesend" ${status === "anwesend" ? "selected" : ""}>Anwesend</option>
                <option value="entschuldigt" ${status === "entschuldigt" ? "selected" : ""}>Entschuldigt</option>
                <option value="unentschuldigt" ${status === "unentschuldigt" ? "selected" : ""}>Unentschuldigt</option>
              </select>
            </td>
          </tr>
        `;
      });

      html += `</table><hr>`;
      container.innerHTML += html;
    });
  });
}

function loadTrainingData() {
  const container = document.getElementById("trainingStats");
  container.innerHTML = "";

  const trainingRef = ref(db, "trainings");
  get(trainingRef).then((snapshot) => {
    const data = snapshot.val();
    if (!data) {
      container.innerHTML = "<p>Keine Trainings gefunden.</p>";
      return;
    }

    Object.entries(data).forEach(([trainingId, training]) => {
      const trainingDate = training.date || trainingId;
      const playerStates = training.players || {};

      let html = `<h4>📅 ${trainingDate}</h4><table><tr><th>Spieler</th><th>Status</th></tr>`;

      players.forEach(player => {
        const status = playerStates[player.id] || "";
        html += `
          <tr>
            <td>${player.name}</td>
            <td>
              <select onchange="updatePlayerTrainingStatus('${trainingId}', '${player.id}', this.value)">
                <option value="">–</option>
                <option value="anwesend" ${status === "anwesend" ? "selected" : ""}>Anwesend</option>
                <option value="entschuldigt" ${status === "entschuldigt" ? "selected" : ""}>Entschuldigt</option>
                <option value="unentschuldigt" ${status === "unentschuldigt" ? "selected" : ""}>Unentschuldigt</option>
              </select>
            </td>
          </tr>`;
      });

      html += "</table><hr>";
      container.innerHTML += html;
    });
  }).catch((error) => {
    console.error("Fehler beim Laden der Trainingsdaten:", error);
    container.innerHTML = "<p>Fehler beim Laden der Trainingsdaten.</p>";
  });
}

function deleteTraining(date) {
  if (!confirm("Möchtest du diesen Trainingstag wirklich löschen?")) return;

  const trainingRef = ref(db, `trainings/${date}`);
  remove(trainingRef)
    .then(() => {
      alert("Trainingstag gelöscht.");
    })
    .catch((error) => {
      console.error("Fehler beim Löschen des Trainings:", error);
    });
}

function updatePlayerTrainingStatus(trainingId, playerId, status) {
  const playerRef = ref(db, `trainings/${trainingId}/players/${playerId}`);
  set(playerRef, status)
    .then(() => {
      console.log(`Status aktualisiert: Spieler ${playerId}, Training ${trainingId}`);
      calculateAttendanceStats(); // 🟢 HIER ergänzen
    })
    .catch((error) => {
      console.error("Fehler beim Speichern des Status:", error);
    });
}

let currentDetailRef = null;

function showPlayerDetails(playerId) {
  const player = players.find(p => p.id === playerId);
  if (!player) return;

  document.getElementById("detailPlayerName").textContent = player.name;
  document.querySelectorAll("section").forEach(s => s.style.display = "none");
  document.getElementById("playerDetails").style.display = "block";

  const ul = document.getElementById("playerPenaltyDetails");
  ul.innerHTML = "";

  const playerRef = ref(db, `playerPenalties/${playerId}`);

  // ⬛ AKTIVE STRAFEN LADEN
  get(playerRef).then((snapshot) => {
    const data = snapshot.val();
    if (!data) {
      ul.innerHTML = "<li>Keine Strafen gefunden</li>";
    } else {
      Object.entries(data).forEach(([key, p]) => {
        const date = p.timestamp ? new Date(p.timestamp).toLocaleString() : "";
        const deleteBtn = (userRole === "admin" || userRole === "editor")
          ? ` <button onclick="deletePlayerPenalty('${playerId}', '${key}')">🗑️</button>`
          : "";

        ul.innerHTML += `<li>${p.name} – ${Number(p.amount).toFixed(2)} € – ${date}${deleteBtn}</li>`;
      });

      if ((userRole === "admin" || userRole === "editor") && Object.keys(data).length > 0) {
        ul.innerHTML += `
          <div style="margin-top: 10px;">
            <button onclick="prepareMarkPenaltiesAsPaid('${playerId}')" style="background-color: green; color: white; padding: 8px 12px; border: none; border-radius: 6px; font-size: 16px;">
              💰 Strafen bezahlt
            </button>
          </div>
        `;
      }
    }

    // 🆕 FIXIERUNG PRÜFEN & ANZEIGEN (nachdem wir wissen, ob es offene Strafen gibt)
    const fixedDiv = document.getElementById("playerFixedAmount");
    const hasOpen = !!data && Object.keys(data).length > 0;

    get(ref(db, `fixedPenalties/${playerId}`)).then((fixSnap) => {
      const fix = fixSnap.val();

      if (fix && typeof fix.amount === "number") {
        const amt = Number(fix.amount) || 0;
        const when = fix.fixedAt ? new Date(fix.fixedAt).toLocaleString() : "";
        fixedDiv.style.display = "block";
        fixedDiv.innerHTML = `
          <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
            <div>💵 <strong>Zu bezahlen (fixiert):</strong> ${amt.toFixed(2)} € <span style="opacity:.7">(${when})</span></div>
            ${(userRole === "admin" || userRole === "editor") ? `
              <div style="display:flex; gap:6px">
                <button onclick="fixCurrentPenalties('${playerId}')" style="background:#3498db; color:#fff; padding:8px 12px; border:none; border-radius:6px;">Aktualisieren</button>
                <button onclick="clearFixedAmount('${playerId}')" style="background:#e74c3c; color:#fff; padding:8px 12px; border:none; border-radius:6px;">Fixierung entfernen</button>
              </div>` : ``}
          </div>
        `;
      } else {
        if ((userRole === "admin" || userRole === "editor") && hasOpen) {
          fixedDiv.style.display = "block";
          fixedDiv.innerHTML = `
            <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
              <div>💵 <strong>Zu bezahlen (fixiert):</strong> –</div>
              <button onclick="fixCurrentPenalties('${playerId}')" style="background:#2ecc71; color:#fff; padding:8px 12px; border:none; border-radius:6px;">Betrag fixieren</button>
            </div>
          `;
        } else {
          fixedDiv.style.display = "none";
          fixedDiv.innerHTML = "";
        }
      }
    }).catch(err => {
      console.error("Fixierung laden:", err);
      if (fixedDiv) { fixedDiv.style.display = "none"; fixedDiv.innerHTML = ""; }
    });

  }).catch((error) => {
    console.error("Fehler beim Laden der Strafen:", error);
    ul.innerHTML = "<li>Fehler beim Laden der Strafen</li>";
  });

  // ⬛ ARCHIVIERTE STRAFEN LADEN
  const historyDiv = document.getElementById("penaltyHistory");
  historyDiv.innerHTML = "<h4>📜 Historie</h4>";

  const archiveRef = ref(db, `paidPenalties/${playerId}`);
  get(archiveRef).then((snapshot) => {
    const data = snapshot.val();
    if (!data) {
      historyDiv.innerHTML += "<p>Keine Zahlungen gefunden.</p>";
      return;
    }

    Object.entries(data).forEach(([key, entry]) => {
      const date = entry.paidAt ? new Date(entry.paidAt).toLocaleString() : "";
      const items = Array.isArray(entry.items) ? entry.items : [];
      const total = items.reduce((sum, p) => sum + (p.amount || 0), 0).toFixed(2);

      let html = `<strong>Zahlung vom ${date} – Gesamt: ${total} €</strong><ul>`;
      items.forEach(p => {
        html += `<li>${p.name} – ${Number(p.amount).toFixed(2)} €</li>`;
      });
      html += "</ul><hr>";
      historyDiv.innerHTML += html;
    });
  }).catch((error) => {
    console.error("Fehler beim Laden der Historie:", error);
    historyDiv.innerHTML += "<p>Fehler beim Laden der Historie.</p>";
  });
}

function deletePlayerPenalty(playerId, penaltyKey) {
  if (!confirm("Möchtest du diese Strafe wirklich löschen?")) return;

  const penaltyRef = ref(db, `playerPenalties/${playerId}/${penaltyKey}`);
  remove(penaltyRef)
    .then(() => {
      alert("Strafe gelöscht.");
      updateSummary(); // 🟢 Strafenübersicht neu berechnen
    })
    .catch((error) => {
      console.error("Fehler beim Löschen der Strafe:", error);
    });
}

function prepareMarkPenaltiesAsPaid(playerId) {
  const playerRef = ref(db, `playerPenalties/${playerId}`);
  get(playerRef).then((snapshot) => {
    const penalties = snapshot.val();
    if (!penalties || Object.keys(penalties).length === 0) {
      alert("Keine offenen Strafen zum Archivieren.");
      return;
    }

    // In ein Array umwandeln (optional, falls du das lieber speicherst)
    const items = Object.values(penalties);

    // Aufruf der Hauptfunktion mit vollständigen Daten
    markPenaltiesAsPaid(playerId, items);
  }).catch((error) => {
    console.error("Fehler beim Laden der Strafen:", error);
  });
}

function markPenaltiesAsPaid(playerId, penalties) {
  if (!confirm("Möchtest du alle Strafen als bezahlt markieren?")) return;

  const timestamp = new Date().toISOString();
  const archiveRef        = ref(db, `paidPenalties/${playerId}/${Date.now()}`);
  const playerPenaltyRef  = ref(db, `playerPenalties/${playerId}`);
  const fixedRef          = ref(db, `fixedPenalties/${playerId}`); // 🆕 Fixierung

  // Alle offenen Strafen ins Archiv schreiben, offene Strafen löschen, Fixierung löschen
  set(archiveRef, {
    paidAt: timestamp,
    items: penalties
  })
  .then(() => remove(playerPenaltyRef))   // offene Strafen leeren
  .then(() => remove(fixedRef))           // 🆕 Fixierten Betrag entfernen
  .then(() => {
    alert("Strafen archiviert, fixierter Betrag entfernt und Übersicht aktualisiert.");
    updateSummary();
    showPlayerDetails(playerId); // Ansicht neu laden
  })
  .catch((error) => {
    console.error("Fehler beim Archivieren:", error);
  });
}

// Betrag aus aktuellen, offenen Strafen "fixieren" (einfrieren)
function fixCurrentPenalties(playerId) {
  const playerPenaltyRef = ref(db, `playerPenalties/${playerId}`);

  get(playerPenaltyRef).then((snap) => {
    const itemsObj = snap.val();
    const items = itemsObj ? Object.values(itemsObj) : [];

    if (items.length === 0) {
      alert("Es gibt aktuell keine offenen Strafen zum Fixieren.");
      return;
    }

    const amount = items.reduce((s, p) => s + (Number(p.amount) || 0), 0);
    const fixedRef = ref(db, `fixedPenalties/${playerId}`);

    // optional: Items mit ablegen, damit der Fixierungsstand nachvollziehbar ist
    return set(fixedRef, {
      amount: Math.round(amount * 100) / 100,
      fixedAt: new Date().toISOString(),
      items
    });
  }).then(() => {
    alert("Betrag fixiert.");
    updateSummary();         // Tabelle neu berechnen/anzeigen
    showPlayerDetails(playerId); // Detailansicht auffrischen
  }).catch((err) => {
    console.error("Fehler beim Fixieren:", err);
    alert("Fehler beim Fixieren.");
  });
}

// Fixierung wieder entfernen
function clearFixedAmount(playerId) {
  if (!confirm("Fixierten Betrag wirklich entfernen?")) return;

  const fixedRef = ref(db, `fixedPenalties/${playerId}`);
  remove(fixedRef).then(() => {
    updateSummary();
    showPlayerDetails(playerId);
  }).catch((err) => {
    console.error("Fehler beim Entfernen der Fixierung:", err);
    alert("Fehler beim Entfernen der Fixierung.");
  });
}

// 🧮 Periode berechnen: "YYYY-H1" (Jan–Jun) / "YYYY-H2" (Jul–Dez)
function getCurrentFundPeriod(d = new Date()) {
  const year = d.getFullYear();
  const half = (d.getMonth() < 6) ? "H1" : "H2";
  return `${year}-${half}`;
}

// Periode Dropdown befüllen (aktuelle + Nachbarperioden)
function buildFundPeriodOptions() {
  const sel = document.getElementById("fundPeriod");
  if (!sel) return;
  sel.innerHTML = "";

  const now = new Date();
  const periods = [];

  // Vorperiode
  const prev = new Date(now);
  prev.setMonth(now.getMonth() - 6);
  periods.push(getCurrentFundPeriod(prev));

  // aktuelle
  const cur = getCurrentFundPeriod(now);
  periods.push(cur);

  // Folgeperiode
  const next = new Date(now);
  next.setMonth(now.getMonth() + 6);
  periods.push(getCurrentFundPeriod(next));

  // Duplikate raus (bei Jahreswechsel selten)
  const uniq = [...new Set(periods)];

  uniq.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    if (p === cur) opt.selected = true;
    sel.appendChild(opt);
  });
}

// Daten laden + Tabelle rendern
function loadTeamFund() {
  const period = document.getElementById("fundPeriod")?.value;
  if (!period) return;

  // Betrag holen
  get(ref(db, `teamFundMeta/${period}`)).then(metaSnap => {
    const meta = metaSnap.val() || {};
    const amountEl = document.getElementById("fundAmount");
    if (amountEl) amountEl.value = (typeof meta.amount === "number" ? meta.amount : 50).toFixed(2);
  });

  // Zahlungsliste holen
  const tbody = document.getElementById("fundTableBody");
  if (tbody) tbody.innerHTML = "";

  get(ref(db, `teamFund/${period}`)).then(snap => {
    const fundData = snap.val() || {};
    // alle Spieler zeigen
    players.forEach(pl => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td style="padding:6px; border-top:1px solid #ddd;">${pl.name}</td>
        <td style="padding:6px; border-top:1px solid #ddd; text-align:center;">
          <input type="checkbox" ${fundData[pl.id]?.paid ? "checked" : ""} 
                 onchange="toggleFundPaid('${pl.id}', this.checked)">
        </td>
        <td style="padding:6px; border-top:1px solid #ddd;">
          ${fundData[pl.id]?.paidAt ? new Date(fundData[pl.id].paidAt).toLocaleDateString() : "—"}
        </td>
      `;
      tbody.appendChild(row);
    });
  });
}

// Checkbox‑Handler: bezahlt an/aus
function toggleFundPaid(playerId, isPaid) {
  const period = document.getElementById("fundPeriod")?.value;
  if (!period) return;

  const nodeRef = ref(db, `teamFund/${period}/${playerId}`);
  if (isPaid) {
    set(nodeRef, { paid: true, paidAt: new Date().toISOString() })
      .catch(err => console.error("toggleFundPaid set:", err));
  } else {
    // Reset
    set(nodeRef, { paid: false }).catch(err => console.error("toggleFundPaid unset:", err));
  }
}

// Betrag speichern
function saveFundAmount() {
  const period = document.getElementById("fundPeriod")?.value;
  const amountEl = document.getElementById("fundAmount");
  if (!period || !amountEl) return;

  const raw = String(amountEl.value || "").replace(",", ".");
  const val = parseFloat(raw);
  if (isNaN(val) || val < 0) {
    alert("Bitte einen gültigen Betrag eingeben.");
    return;
  }

  set(ref(db, `teamFundMeta/${period}`), { amount: Math.round(val * 100) / 100 })
    .then(() => alert("Betrag gespeichert."))
    .catch(err => console.error("saveFundAmount:", err));
}

// 🔎 Alle Perioden laden (als Array)
function loadFundPeriods() {
  return get(ref(db, "teamFundPeriods"))
    .then(snap => {
      const obj = snap.val() || {};
      // Keys alphabetisch (damit 2025-H1, 2025-H2, 2026-H1 …)
      return Object.keys(obj).sort();
    });
}

// ⬇️ Dropdown aus Periodenliste bauen
function buildFundPeriodOptionsFromList(periods) {
  const sel = document.getElementById("fundPeriod");
  if (!sel) return;
  sel.innerHTML = "";

  if (!periods || periods.length === 0) {
    // Falls noch keine Periode existiert, Hinweis und fertig
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "— keine Periode angelegt —";
    sel.appendChild(opt);
    return;
  }

  periods.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    sel.appendChild(opt);
  });

  // Standard: letzte (neueste) Periode auswählen
  sel.value = periods[periods.length - 1];
}

// ➕ Periode hinzufügen
function addFundPeriod() {
  const inp = document.getElementById("newFundPeriod");
  if (!inp) return;
  const raw = (inp.value || "").trim();

  if (!raw) {
    alert("Bitte eine Periode angeben (z. B. 2025-H1 oder 2025-Q1).");
    return;
  }

  // Optional: einfache Validierung
  // if (!/^\d{4}-(H1|H2|Q[1-4])$/.test(raw)) {
  //   alert("Ungültiges Format. Beispiel: 2025-H1, 2025-Q2.");
  //   return;
  // }

  set(ref(db, `teamFundPeriods/${raw}`), true)
    .then(() => {
      inp.value = "";
      // Liste neu laden + UI aktualisieren
      refreshFundPeriodsUI();
    })
    .catch(err => console.error("addFundPeriod:", err));
}

// 🗑️ Periode löschen (nur wenn du möchtest)
function deleteFundPeriod(key) {
  if (!confirm(`Periode "${key}" wirklich löschen? (Zahlungsdaten bleiben bestehen)`)) return;

  remove(ref(db, `teamFundPeriods/${key}`))
    .then(() => refreshFundPeriodsUI())
    .catch(err => console.error("deleteFundPeriod:", err));
}

// 🔁 Periodenliste + Dropdown + Tabelle aktualisieren
function refreshFundPeriodsUI() {
  loadFundPeriods().then(periods => {
    // Liste rendern
    const list = document.getElementById("fundPeriodsList");
    if (list) {
      list.innerHTML = "";
      periods.forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span>${p}</span>
          <button style="margin-left:8px" onclick="deleteFundPeriod('${p}')">🗑️</button>
        `;
        list.appendChild(li);
      });
    }

    // Dropdown neu bauen
    buildFundPeriodOptionsFromList(periods);
    // Tabelle + Betrag zur ausgewählten Periode laden
    loadTeamFund();
  });
}

</script>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, push, remove , off , update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
  import { firebaseConfig } from "./firebase-config.js"; // ⬅️ Hier wird die externe Datei eingebunden

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  
  const playersRef = ref(db, "players");
  const eventRef = ref(db, "events");
  const docsRef = ref(db, "documents");



  // Globale Referenz verfügbar machen
  window.db = db;
  window.ref = ref;
  window.set = set;
  window.get = get;
  window.onValue = onValue;
  window.push = push;
  window.remove = remove;
   </script>

<section id="playerDetails" style="display:none">
  <h2>🔍 Einzelne Strafen für <span id="detailPlayerName"></span></h2>

  <!-- 🆕 Platzhalter für fixierte Summe -->
  <div id="playerFixedAmount" style="font-weight: bold; color: darkred; display:none;"></div>

  <ul id="playerPenaltyDetails"></ul>
  <div id="penaltyHistory"></div>
  <button onclick="switchPage('home')">🔙 Zurück</button>
</section>

<footer style="text-align: center; padding: 20px;">
  <button onclick="logout()" style="padding: 10px 20px; font-size: 16px;">🔐 Zurück zur Anmeldung</button>
</footer>

</body>
</html>

