<!DOCTYPE html>

<html lang="de">

<head>

  <meta charset="UTF-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Mannschaftsapp ‚Äì Strafenkasse</title>

  <link rel="manifest" href="manifest.json">

  <link rel="icon" type="image/png" href="TSV.png">

  <meta name="theme-color" content="#c42805">

  <style>

    body { font-family: sans-serif; background: #f5f5f5; margin: 0; }

    header { background: #000; color: white; padding: 15px; text-align: center; }

    nav { display: flex; justify-content: center; background: #c42805; flex-wrap: wrap; }

    nav button {

      background: none; border: none; color: white; padding: 15px;

      cursor: pointer; font-size: 16px;

    }

    nav button:hover { background: #a30000; }

    section { max-width: 800px; margin: auto; padding: 20px; display: none; }

    input, select, button {

      padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box;

    }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; }

    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }

    .clickable { cursor: pointer; color: blue; text-decoration: underline; }

    #modal {

      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;

      background: rgba(0,0,0,0.5); justify-content: center; align-items: center;

    }

    #modalContent {

      background: white; padding: 20px; max-width: 500px; max-height: 80vh;

      overflow-y: auto; border-radius: 5px;

    }

  </style>

</head>

<body>


<header>

  <h1>‚öΩ Mannschafts-App <br> TSV Dramfeld</h1>

</header>


<nav>

  <button onclick="switchPage('home')">Strafen</button>

  <button onclick="switchPage('catalog')">Strafenkatalog</button>

  <button onclick="switchPage('schedule')">Termine</button>

  <button onclick="switchPage('docs')">Dokumente</button>

</nav>


<section id="login">

  <h2>üîê Zugang</h2>

  <input type="password" id="pinInput" placeholder="PIN eingeben" />

  <button onclick="checkPIN()">Weiter</button>

</section>


<section id="home">

  <h2>Strafen√ºbersicht</h2>

  <div id="penaltyEntry">

    <select id="playerSelect"></select>

    <select id="penaltySelect"></select>

    <button onclick="addPenalty()">Strafe eintragen</button>

  </div>

  <table>

    <thead><tr><th>Spieler</th><th>Summe (‚Ç¨)</th></tr></thead>

    <tbody id="summaryTable"></tbody>

  </table>

</section>


<section id="catalog">

  <h2>Strafenkatalog</h2>

  <ul id="penaltyList"></ul>

</section>


<section id="schedule">

  <h2>Termine</h2>

  <ul id="eventList"></ul>

</section>


<section id="docs">

  <h2>Dokumente</h2>

  <ul id="docList"></ul>

</section>


<section id="adminPanel">

  <h2>üîß Admin Panel</h2>

  <div>

    <h3>Strafen</h3>

    <input id="newPenaltyName" placeholder="Strafe" />

    <input id="newPenaltyAmount" type="number" placeholder="Betrag" />

    <button onclick="addNewPenalty()">Hinzuf√ºgen</button>

    <ul id="adminPenaltyList"></ul>


    <h3>Spieler</h3>

    <input id="newPlayer" placeholder="Spielername" />

    <button onclick="addNewPlayer()">Hinzuf√ºgen</button>

    <ul id="adminPlayerList"></ul>


    <h3>Dokumente</h3>

    <input id="newDocName" placeholder="Name" />

    <input id="newDocURL" placeholder="https://..." />

    <button onclick="addNewDoc()">Hinzuf√ºgen</button>

    <ul id="adminDocList"></ul>


    <h3>Termine</h3>

    <input id="newEventText" placeholder="Terminbeschreibung" />

    <input id="newEventDate" type="date" />

    <button onclick="addNewEvent()">Hinzuf√ºgen</button>

    <ul id="adminEventList"></ul>

  </div>

</section>


<!-- Modal -->

<div id="modal">

  <div id="modalContent">

    <h3 id="modalTitle"></h3>

    <ul id="modalDetails"></ul>

    <button onclick="closeModal()">Zur√ºck</button>

  </div>

</div>


<!-- Firebase Integration -->

<script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";

  import { getDatabase, ref, set, get, onValue, push, update } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";


  const firebaseConfig = {

    apiKey: "AIzaSyAb5J0yQMnNvSOtqfWvqFaaoVBjRRZxUaA",

    authDomain: "tsv-app-54006.firebaseapp.com",

    projectId: "tsv-app-54006",

    storageBucket: "tsv-app-54006.appspot.com",

    messagingSenderId: "694629601085",

    appId: "1:694629601085:web:4d40166a2d5445e3113f54",

    databaseURL: "https://tsv-app-54006-default-rtdb.europe-west1.firebasedatabase.app"

  };


  const app = initializeApp(firebaseConfig);

  const db = getDatabase(app);


  const BASIC_PIN = "1919_2025";

  const POWER_PIN = "TSV!1919";

  const ADMIN_PIN = "Strafen!2025";


  let userRole = null;


  const ROLE_VIEWER = "viewer";

  const ROLE_EDITOR = "editor";

  const ROLE_ADMIN = "admin";


  const pages = ["home", "catalog", "schedule", "docs", "adminPanel", "login"];


  const switchPage = (id) => {

    if (!sessionStorage.getItem("role") && id !== "login") {

      alert("Bitte zuerst PIN eingeben."); id = "login";

    }

    pages.forEach(p => document.getElementById(p).style.display = "none");

    const el = document.getElementById(id);

    if (el) el.style.display = "block";

  };


  window.onload = () => {

    const savedRole = sessionStorage.getItem("role");

    if (savedRole) {

      userRole = savedRole;

      switchPage(savedRole === ROLE_ADMIN ? "adminPanel" : "home");

      loadData();

    } else {

      switchPage("login");

    }

  };


  window.checkPIN = () => {

    const pin = document.getElementById("pinInput").value;

    if (pin === BASIC_PIN) {

      userRole = ROLE_VIEWER;

    } else if (pin === POWER_PIN) {

      userRole = ROLE_EDITOR;

    } else if (pin === ADMIN_PIN) {

      userRole = ROLE_ADMIN;

    } else {

      alert("Falsche PIN"); return;

    }

    sessionStorage.setItem("role", userRole);

    switchPage(userRole === ROLE_ADMIN ? "adminPanel" : "home");

    loadData();

  };


  // -------------------------------

  // üîÑ Live-Daten aus Firebase laden

  // -------------------------------

  let penalties = [], players = [], docs = [], events = [], playerPenalties = {};


  function loadData() {

    onValue(ref(db, "penaltiesList"), snap => {

      penalties = snap.val() || [];

      updateSelects(); updatePenaltyList(); updateAdminPanel();

    });


    onValue(ref(db, "players"), snap => {

      players = snap.val() || [];

      updateSelects(); updateSummary(); updateAdminPanel();

    });


    onValue(ref(db, "docs"), snap => {

      docs = snap.val() || [];

      updateDocList(); updateAdminPanel();

    });


    onValue(ref(db, "events"), snap => {

      events = snap.val() || [];

      updateEventList(); updateAdminPanel();

    });


    onValue(ref(db, "playerPenalties"), snap => {

      playerPenalties = snap.val() || {};

      updateSummary();

    });


    document.getElementById("penaltyEntry").style.display =

      userRole === ROLE_ADMIN || userRole === ROLE_EDITOR ? "block" : "none";

  }


  function updateSelects() {

    const ps = document.getElementById("playerSelect");

    const pe = document.getElementById("penaltySelect");

    ps.innerHTML = ""; pe.innerHTML = "";

    players.forEach(p => ps.innerHTML += `<option>${p}</option>`);

    penalties.forEach((p, i) => pe.innerHTML += `<option value="${i}">${p.name} (${p.amount} ‚Ç¨)</option>`);

  }


  window.addPenalty = () => {

    const player = document.getElementById("playerSelect").value;

    const idx = document.getElementById("penaltySelect").value;

    const pen = penalties[idx];

    const entry = {

      name: pen.name,

      amount: pen.amount,

      date: new Date().toISOString().split("T")[0]

    };

    push(ref(db, `playerPenalties/${player}`), entry);

  };


  function updateSummary() {

    const tb = document.getElementById("summaryTable");

    tb.innerHTML = "";

    players.forEach(p => {

      const total = (playerPenalties[p] ? Object.values(playerPenalties[p]).reduce((sum, e) => sum + Number(e.amount), 0) : 0).toFixed(2);

      tb.innerHTML += `<tr><td class="clickable" onclick="showDetails('${p}')">${p}</td><td>${total} ‚Ç¨</td></tr>`;

    });

  }


  function updatePenaltyList() {

    document.getElementById("penaltyList").innerHTML = penalties.map(p => `<li>${p.name} ‚Äì ${p.amount} ‚Ç¨</li>`).join("");

  }


  function updateEventList() {

    document.getElementById("eventList").innerHTML = events.map(e => `<li>üìÖ ${e.date} ‚Äì ${e.text}</li>`).join("");

  }


  function updateDocList() {

    document.getElementById("docList").innerHTML = docs.map(d => `<li><a href="${d.url}" target="_blank">${d.name}</a></li>`).join("");

  }


  function updateAdminPanel() {

    document.getElementById("adminPenaltyList").innerHTML =

      penalties.map((p, i) => `<li>${p.name} ‚Äì ${p.amount} ‚Ç¨</li>`).join("");

    document.getElementById("adminPlayerList").innerHTML =

      players.map((p, i) => `<li>${p}</li>`).join("");

    document.getElementById("adminDocList").innerHTML =

      docs.map((d, i) => `<li>${d.name}</li>`).join("");

    document.getElementById("adminEventList").innerHTML =

      events.map((e, i) => `<li>${e.date} ‚Äì ${e.text}</li>`).join("");

  }


  // Admin-Funktionen

  window.addNewPenalty = () => {

    const name = document.getElementById("newPenaltyName").value;

    const amount = parseFloat(document.getElementById("newPenaltyAmount").value);

    if (!name || isNaN(amount)) return;

    set(ref(db, `penaltiesList/${penalties.length}`), { name, amount });

  };


  window.addNewPlayer = () => {

    const name = document.getElementById("newPlayer").value;

    if (!name) return;

    set(ref(db, `players/${players.length}`), name);

  };


  window.addNewDoc = () => {

    const name = document.getElementById("newDocName").value;

    const url = document.getElementById("newDocURL").value;

    if (!name || !url) return;

    set(ref(db, `docs/${docs.length}`), { name, url });

  };


  window.addNewEvent = () => {

    const text = document.getElementById("newEventText").value;

    const date = document.getElementById("newEventDate").value;

    if (!text || !date) return;

    set(ref(db, `events/${events.length}`), { text, date });

  };


  // MODAL Detailansicht

  window.showDetails = (player) => {

    const list = playerPenalties[player];

    const modal = document.getElementById("modal");

    document.getElementById("modalTitle").innerText = `Strafen f√ºr ${player}`;

    const ul = document.getElementById("modalDetails");

    ul.innerHTML = "";

    if (!list) {

      ul.innerHTML = "<li>Keine Strafen</li>";

    } else {

      Object.values(list).forEach(p =>

        ul.innerHTML += `<li>${p.date}: ${p.name} ‚Äì ${p.amount} ‚Ç¨</li>`

      );

    }

    modal.style.display = "flex";

  };


  window.closeModal = () => {

    document.getElementById("modal").style.display = "none";

  };

</script>


</body>

</html>